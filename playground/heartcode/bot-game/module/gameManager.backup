let playerCount = 0;
let playersReady = [];

function increasePlayerCount() {
  playerCount++;
}

function decreasePlayerCount() {
  playerCount--;
}

function setPlayerCount(count) {
  playerCount = count;
}

function playerReady(nickname, ircClient) {
  if (!playersReady.includes(nickname)) {
    playersReady.push(nickname);
    const remainingPlayers = playersReady.length;

    ircClient.say(
      '#awesomeplayground',
      `Player ${nickname} is ready. Waiting ${remainingPlayers}/4 players.`
    );

    console.log(
      `[BOT] <${ircClient.nick}> Player ${nickname} is ready. Waiting for ${remainingPlayers}/4 players.`
    );

    // Check if the required number of players is reached
    if (playersReady.length === 4) {

      // True Game Start HERE
      //
      initializeGame(ircClient);
    }
  }
}

function displayStartMessage(ircClient) {
  if (playerCount >= 4) {
    ircClient.say('#awesomeplayground', '4 people have now joined. Please get ready!');

    console.log(`[BOT] <${ircClient.nick}> 4 people have now joined. Please get ready!`);
  }
}

// IRC Post and log the message
function sendAndLogMessage(ircClient, channel, message) {
  setTimeout(() => {
    // Send the message to IRC after the delay
    ircClient.say(channel, message);

    // Log the message to console
    console.log(message);
  }, 3000); // 5000 milliseconds = 5 seconds  

}

const welcomeMessage = `
Welcome to the Mafia Mayor's Game!

ðŸŽ­ Get ready for an immersive Mafia experience! ðŸŒƒ

You are about to embark on a thrilling journey in the world of deceit, strategy, and mystery. As a player in this 4-player Mafia game, you'll be faced with challenges, alliances, and unexpected twists.

ðŸ” Your mission, should you choose to accept it, is to navigate the treacherous streets of the virtual town, uncovering the identity of the Mafia members and working with your fellow townspeople to ensure the safety of the community.

Remember, the Mafia could be anyone â€“ even your closest allies.
Good luck, and may the town be in your favor!
`

// Function to assign roles to players
function assignRoles(ircClient, channel) {
  const players = Object.keys(ircClient.chans[channel].users); // Assuming the IRC client provides a list of users in the channel
  const roles = ['Townspeople', 'Townspeople', 'Sheriff', 'Mafia'];
  shuffleArray(roles);

  const playerRoles = {};

  players.forEach((player, index) => {
    // Send a public IRC message for each player's role
    const roleMessage = `Player ${player}, you are a ${roles[index]}.`;
    sendAndLogMessage(ircClient, channel, roleMessage);

    // Log the role to the console
    console.log(`${player}: ${roles[index]}`);

    // Store the role in the playerRoles mapping
    playerRoles[player] = roles[index];
  });

  // Send a summary message to the channel
  const summaryMessage = 'Roles have been assigned. Let the game begin!';
  sendAndLogMessage(ircClient, channel, summaryMessage);

  // Return the playerRoles mapping
  return playerRoles;
}

// Shuffle function to randomize the array
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}


async function initializeGame(ircClient) {

  // Execute sendAndLogMessage and wait for it to complete
  await sendAndLogMessage(ircClient, '#awesomeplayground', welcomeMessage);
  // Execute assignRoles after sendAndLogMessage is complete
  assignRoles(ircClient, '#awesomeplayground');
}


module.exports = {
  increasePlayerCount,
  decreasePlayerCount,
  setPlayerCount,
  displayStartMessage,
  playerReady,
  getPlayerCount: () => playerCount,
};


